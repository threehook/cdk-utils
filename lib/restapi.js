"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.constParam = exports.RestApi = void 0;
const cdk = require("@aws-cdk/core");
const apigateway = require("@aws-cdk/aws-apigateway");
const api_keys_1 = require("./api_keys");
const proxyparameter_1 = require("./proxyparameter");
class RestApi extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        this.api = new apigateway.RestApi(this, 'Api', RestApi.apiProps(props));
        if (props.apiKeys) {
            api_keys_1.addApiKeysToApi(this.api, props.apiKeys);
        }
        this.authorizer = props.authorizer;
        this.proxyRoot = props.proxyRoot ? props.proxyRoot : '/api';
        if (props.corsAllowOrigin) {
            this.newGatewayResponse(apigateway.ResponseType.DEFAULT_4XX, props.corsAllowOrigin);
            this.newGatewayResponse(apigateway.ResponseType.DEFAULT_5XX, props.corsAllowOrigin);
        }
    }
    static apiProps(props) {
        return {
            defaultCorsPreflightOptions: props.corsAllowOrigin ? {
                allowOrigins: [props.corsAllowOrigin],
                allowHeaders: ['Authorization,Content-Type'],
            } : undefined,
            defaultMethodOptions: {
                apiKeyRequired: (props.apiKeys !== undefined && props.apiKeys.length > 0),
            },
            apiKeySourceType: props.apiKeySourceType,
            deployOptions: {
                tracingEnabled: true,
                stageName: props.stage,
            },
            endpointConfiguration: {
                types: [apigateway.EndpointType.REGIONAL]
            },
            restApiName: props.name,
        };
    }
    get root() {
        return this.api.root;
    }
    newGatewayResponse(type, corsAllowOrigin) {
        return this.api.addGatewayResponse(`GatewayResponse${type.responseType}`, {
            type,
            responseHeaders: {
                'Access-Control-Allow-Origin': constParam(corsAllowOrigin),
                'Access-Control-Allow-Headers': constParam('Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'),
                'Access-Control-Allow-Methods': constParam('OPTIONS'),
            }
        });
    }
    withFunctionOn(path, method, fct) {
        let options = {};
        if (this.authorizer) {
            options = {
                authorizer: this.authorizer
            };
        }
        this.root.resourceForPath(path).addMethod(method, new apigateway.LambdaIntegration(fct), options);
    }
    withProxyOn(path, method, serverSecret, params) {
        const allParams = proxyparameter_1.unique(params.concat(proxyparameter_1.parametersFromPath(path)));
        this.root.resourceForPath(this.proxyRoot + path).addMethod(method, new apigateway.HttpIntegration(baseProxyUrl(serverSecret) + path, {
            httpMethod: method,
            proxy: false,
            options: {
                requestParameters: withAPIKey(proxyparameter_1.backendRequestParamsFor(allParams), serverSecret),
                requestTemplates: proxyparameter_1.requestTemplatesFor(allParams),
                integrationResponses: integrationResponses(),
                passthroughBehavior: apigateway.PassthroughBehavior.WHEN_NO_MATCH,
            }
        }), {
            authorizationType: apigateway.AuthorizationType.CUSTOM,
            authorizer: this.authorizer,
            requestParameters: proxyparameter_1.acceptRequestParamsFor(allParams),
            methodResponses: methodResponses(),
        });
    }
    ;
}
exports.RestApi = RestApi;
function baseProxyUrl(secret) {
    return secret.secretValueFromJson('url').toString();
}
function integrationResponses() {
    return supportedResponses.map(integrationResponseFor);
}
function methodResponses() {
    return supportedResponses.map((statusCode) => {
        return { statusCode: statusCode.toString(10) };
    });
}
function integrationResponseFor(statusCode) {
    const statusCodeStr = statusCode.toString(10);
    return {
        statusCode: statusCodeStr,
        selectionPattern: statusCodeStr, //TODO verify that cors is not necessary because of defaultCorsPreflightOptions
    };
}
function withAPIKey(requestParams, apiKeySecret) {
    requestParams['integration.request.header.X-API-Key'] = constParam(apiKeySecret.secretValueFromJson('apiKey').toString());
    return requestParams;
}
function constParam(parameter) {
    return `'${parameter}'`;
}
exports.constParam = constParam;
const supportedResponses = [200, 201, 202, 204, 400, 401, 403, 404, 405, 406, 408, 409, 412, 413, 422, 425, 428, 429, 500, 501, 502, 503, 504];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdGFwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlc3RhcGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUNBQXFDO0FBQ3JDLHNEQUFzRDtBQUV0RCx5Q0FBMEQ7QUFFMUQscURBQW9KO0FBWXBKLE1BQWEsT0FBUSxTQUFRLEdBQUcsQ0FBQyxTQUFTO0lBMEJ0QyxZQUFZLEtBQW9CLEVBQUUsRUFBVSxFQUFFLEtBQW1CO1FBQzdELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFakIsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDeEUsSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFO1lBQ2YsMEJBQWUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQTtTQUMzQztRQUVELElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQTtRQUVsQyxJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUU1RCxJQUFJLEtBQUssQ0FBQyxlQUFlLEVBQUU7WUFDdkIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUNwRixJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1NBQ3ZGO0lBQ0wsQ0FBQztJQXJDRCxNQUFNLENBQUMsUUFBUSxDQUFDLEtBQW1CO1FBQy9CLE9BQU87WUFDSCwyQkFBMkIsRUFBRSxLQUFLLENBQUMs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LEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjZGsgZnJvbSAnQGF3cy1jZGsvY29yZSc7XG5pbXBvcnQgKiBhcyBhcGlnYXRld2F5IGZyb20gJ0Bhd3MtY2RrL2F3cy1hcGlnYXRld2F5JztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdAYXdzLWNkay9hd3MtbGFtYmRhJztcbmltcG9ydCB7IGFkZEFwaUtleXNUb0FwaSwgQXBpS2V5RGVzY3IgfSBmcm9tICcuL2FwaV9rZXlzJztcbmltcG9ydCB7IElTZWNyZXQgfSBmcm9tIFwiQGF3cy1jZGsvYXdzLXNlY3JldHNtYW5hZ2VyXCI7XG5pbXBvcnQgeyBQcm94eVBhcmFtZXRlciwgYmFja2VuZFJlcXVlc3RQYXJhbXNGb3IsIGFjY2VwdFJlcXVlc3RQYXJhbXNGb3IsIHJlcXVlc3RUZW1wbGF0ZXNGb3IsIHVuaXF1ZSwgcGFyYW1ldGVyc0Zyb21QYXRoIH0gZnJvbSAnLi9wcm94eXBhcmFtZXRlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVzdEFwaVByb3BzIHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgc3RhZ2U6IHN0cmluZztcbiAgICBjb3JzQWxsb3dPcmlnaW4/OiBzdHJpbmc7XG4gICAgYXV0aG9yaXplcj86IGFwaWdhdGV3YXkuSUF1dGhvcml6ZXI7XG4gICAgYXBpS2V5U291cmNlVHlwZT86IGFwaWdhdGV3YXkuQXBpS2V5U291cmNlVHlwZTtcbiAgICBhcGlLZXlzPzogQXBpS2V5RGVzY3JbXTtcbiAgICBwcm94eVJvb3Q/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBSZXN0QXBpIGV4dGVuZHMgY2RrLkNvbnN0cnVjdCB7XG4gICAgcmVhZG9ubHkgYXBpOiBhcGlnYXRld2F5LlJlc3RBcGk7XG4gICAgcmVhZG9ubHkgYXV0aG9yaXplcj86IGFwaWdhdGV3YXkuSUF1dGhvcml6ZXI7XG4gICAgcmVhZG9ubHkgcHJveHlSb290OiBzdHJpbmc7XG5cbiAgICBzdGF0aWMgYXBpUHJvcHMocHJvcHM6IFJlc3RBcGlQcm9wcyk6IGFwaWdhdGV3YXkuUmVzdEFwaVByb3BzIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGRlZmF1bHRDb3JzUHJlZmxpZ2h0T3B0aW9uczogcHJvcHMuY29yc0FsbG93T3JpZ2luID8ge1xuICAgICAgICAgICAgICAgIGFsbG93T3JpZ2luczogW3Byb3BzLmNvcnNBbGxvd09yaWdpbl0sXG4gICAgICAgICAgICAgICAgYWxsb3dIZWFkZXJzOiBbJ0F1dGhvcml6YXRpb24sQ29udGVudC1UeXBlJ10sXG4gICAgICAgICAgICB9IDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgZGVmYXVsdE1ldGhvZE9wdGlvbnM6IHtcbiAgICAgICAgICAgICAgICBhcGlLZXlSZXF1aXJlZDogKHByb3BzLmFwaUtleXMgIT09IHVuZGVmaW5lZCAmJiBwcm9wcy5hcGlLZXlzLmxlbmd0aCA+IDApLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGFwaUtleVNvdXJjZVR5cGU6IHByb3BzLmFwaUtleVNvdXJjZVR5cGUsXG4gICAgICAgICAgICBkZXBsb3lPcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgdHJhY2luZ0VuYWJsZWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgc3RhZ2VOYW1lOiBwcm9wcy5zdGFnZSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlbmRwb2ludENvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgICAgICAgICB0eXBlczogW2FwaWdhdGV3YXkuRW5kcG9pbnRUeXBlLlJFR0lPTkFMXVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHJlc3RBcGlOYW1lOiBwcm9wcy5uYW1lLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogUmVzdEFwaVByb3BzKSB7XG4gICAgICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICAgICAgdGhpcy5hcGkgPSBuZXcgYXBpZ2F0ZXdheS5SZXN0QXBpKHRoaXMsICdBcGknLCBSZXN0QXBpLmFwaVByb3BzKHByb3BzKSk7XG4gICAgICAgIGlmIChwcm9wcy5hcGlLZXlzKSB7XG4gICAgICAgICAgICBhZGRBcGlLZXlzVG9BcGkodGhpcy5hcGksIHByb3BzLmFwaUtleXMpXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmF1dGhvcml6ZXIgPSBwcm9wcy5hdXRob3JpemVyXG5cbiAgICAgICAgdGhpcy5wcm94eVJvb3QgPSBwcm9wcy5wcm94eVJvb3QgPyBwcm9wcy5wcm94eVJvb3QgOiAnL2FwaSc7XG5cbiAgICAgICAgaWYgKHByb3BzLmNvcnNBbGxvd09yaWdpbikge1xuICAgICAgICAgICAgdGhpcy5uZXdHYXRld2F5UmVzcG9uc2UoYXBpZ2F0ZXdheS5SZXNwb25zZVR5cGUuREVGQVVMVF80WFgsIHByb3BzLmNvcnNBbGxvd09yaWdpbik7XG4gICAgICAgICAgICB0aGlzLm5ld0dhdGV3YXlSZXNwb25zZShhcGlnYXRld2F5LlJlc3BvbnNlVHlwZS5ERUZBVUxUXzVYWCwgcHJvcHMuY29yc0FsbG93T3JpZ2luKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGdldCByb290KCk6IGFwaWdhdGV3YXkuSVJlc291cmNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpLnJvb3Q7XG4gICAgfVxuXG4gICAgbmV3R2F0ZXdheVJlc3BvbnNlKHR5cGU6IGFwaWdhdGV3YXkuUmVzcG9uc2VUeXBlLCBjb3JzQWxsb3dPcmlnaW46IHN0cmluZyk6IGFwaWdhdGV3YXkuR2F0ZXdheVJlc3BvbnNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpLmFkZEdhdGV3YXlSZXNwb25zZShgR2F0ZXdheVJlc3BvbnNlJHt0eXBlLnJlc3BvbnNlVHlwZX1gLCB7XG4gICAgICAgICAgICB0eXBlLFxuICAgICAgICAgICAgcmVzcG9uc2VIZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6IGNvbnN0UGFyYW0oY29yc0FsbG93T3JpZ2luKSxcbiAgICAgICAgICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6IGNvbnN0UGFyYW0oJ0NvbnRlbnQtVHlwZSxYLUFtei1EYXRlLEF1dGhvcml6YXRpb24sWC1BcGktS2V5LFgtQW16LVNlY3VyaXR5LVRva2VuJyksXG4gICAgICAgICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnOiBjb25zdFBhcmFtKCdPUFRJT05TJyksXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHdpdGhGdW5jdGlvbk9uKHBhdGg6IHN0cmluZywgbWV0aG9kOiBzdHJpbmcsIGZjdDogbGFtYmRhLkZ1bmN0aW9uKTogdm9pZCB7XG4gICAgICAgIGxldCBvcHRpb25zOiBhcGlnYXRld2F5Lk1ldGhvZE9wdGlvbnMgPSB7fVxuICAgICAgICBpZiAodGhpcy5hdXRob3JpemVyKSB7XG4gICAgICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIGF1dGhvcml6ZXI6IHRoaXMuYXV0aG9yaXplclxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMucm9vdC5yZXNvdXJjZUZvclBhdGgocGF0aCkuYWRkTWV0aG9kKG1ldGhvZCwgbmV3IGFwaWdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24oZmN0KSwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgd2l0aFByb3h5T24ocGF0aDogc3RyaW5nLCBtZXRob2Q6IHN0cmluZywgc2VydmVyU2VjcmV0OiBJU2VjcmV0LCBwYXJhbXM6IFByb3h5UGFyYW1ldGVyW10pOiB2b2lkIHtcbiAgICAgICAgY29uc3QgYWxsUGFyYW1zID0gdW5pcXVlKHBhcmFtcy5jb25jYXQocGFyYW1ldGVyc0Zyb21QYXRoKHBhdGgpKSk7XG4gICAgICAgIHRoaXMucm9vdC5yZXNvdXJjZUZvclBhdGgodGhpcy5wcm94eVJvb3QgKyBwYXRoKS5hZGRNZXRob2QobWV0aG9kLCBuZXcgYXBpZ2F0ZXdheS5IdHRwSW50ZWdyYXRpb24oYmFzZVByb3h5VXJsKHNlcnZlclNlY3JldCkgKyBwYXRoLCB7XG4gICAgICAgICAgICBodHRwTWV0aG9kOiBtZXRob2QsXG4gICAgICAgICAgICBwcm94eTogZmFsc2UsXG4gICAgICAgICAgICBvcHRpb25zOiB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdFBhcmFtZXRlcnM6IHdpdGhBUElLZXkoYmFja2VuZFJlcXVlc3RQYXJhbXNGb3IoYWxsUGFyYW1zKSwgc2VydmVyU2VjcmV0KSxcbiAgICAgICAgICAgICAgICByZXF1ZXN0VGVtcGxhdGVzOiByZXF1ZXN0VGVtcGxhdGVzRm9yKGFsbFBhcmFtcyksXG4gICAgICAgICAgICAgICAgaW50ZWdyYXRpb25SZXNwb25zZXM6IGludGVncmF0aW9uUmVzcG9uc2VzKCksXG4gICAgICAgICAgICAgICAgcGFzc3Rocm91Z2hCZWhhdmlvcjogYXBpZ2F0ZXdheS5QYXNzdGhyb3VnaEJlaGF2aW9yLldIRU5fTk9fTUFUQ0gsXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pLCB7XG4gICAgICAgICAgICBhdXRob3JpemF0aW9uVHlwZTogYXBpZ2F0ZXdheS5BdXRob3JpemF0aW9uVHlwZS5DVVNUT00sXG4gICAgICAgICAgICBhdXRob3JpemVyOiB0aGlzLmF1dGhvcml6ZXIsXG4gICAgICAgICAgICByZXF1ZXN0UGFyYW1ldGVyczogYWNjZXB0UmVxdWVzdFBhcmFtc0ZvcihhbGxQYXJhbXMpLFxuICAgICAgICAgICAgbWV0aG9kUmVzcG9uc2VzOiBtZXRob2RSZXNwb25zZXMoKSxcbiAgICAgICAgfSlcbiAgICB9O1xufVxuXG5cbmZ1bmN0aW9uIGJhc2VQcm94eVVybChzZWNyZXQ6IElTZWNyZXQpOiBzdHJpbmcge1xuICAgIHJldHVybiBzZWNyZXQuc2VjcmV0VmFsdWVGcm9tSnNvbigndXJsJykudG9TdHJpbmcoKVxufVxuXG5mdW5jdGlvbiBpbnRlZ3JhdGlvblJlc3BvbnNlcygpOiBhcGlnYXRld2F5LkludGVncmF0aW9uUmVzcG9uc2VbXSB7XG4gICAgcmV0dXJuIHN1cHBvcnRlZFJlc3BvbnNlcy5tYXAoaW50ZWdyYXRpb25SZXNwb25zZUZvcik7XG59XG5cbmZ1bmN0aW9uIG1ldGhvZFJlc3BvbnNlcygpOiBhcGlnYXRld2F5Lk1ldGhvZFJlc3BvbnNlW10ge1xuICAgIHJldHVybiBzdXBwb3J0ZWRSZXNwb25zZXMubWFwKChzdGF0dXNDb2RlOiBudW1iZXIpID0+IHtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogc3RhdHVzQ29kZS50b1N0cmluZygxMCkgfTtcbiAgICB9KVxufVxuXG5mdW5jdGlvbiBpbnRlZ3JhdGlvblJlc3BvbnNlRm9yKHN0YXR1c0NvZGU6IG51bWJlcik6IGFwaWdhdGV3YXkuSW50ZWdyYXRpb25SZXNwb25zZSB7XG4gICAgY29uc3Qgc3RhdHVzQ29kZVN0ciA9IHN0YXR1c0NvZGUudG9TdHJpbmcoMTApXG4gICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogc3RhdHVzQ29kZVN0cixcbiAgICAgICAgc2VsZWN0aW9uUGF0dGVybjogc3RhdHVzQ29kZVN0ciwvL1RPRE8gdmVyaWZ5IHRoYXQgY29ycyBpcyBub3QgbmVjZXNzYXJ5IGJlY2F1c2Ugb2YgZGVmYXVsdENvcnNQcmVmbGlnaHRPcHRpb25zXG4gICAgfVxufVxuXG5mdW5jdGlvbiB3aXRoQVBJS2V5KHJlcXVlc3RQYXJhbXM6IHsgW25hbWU6IHN0cmluZ106IHN0cmluZyB9LCBhcGlLZXlTZWNyZXQ6IElTZWNyZXQpOiB7IFtuYW1lOiBzdHJpbmddOiBzdHJpbmcgfSB7XG4gICAgcmVxdWVzdFBhcmFtc1snaW50ZWdyYXRpb24ucmVxdWVzdC5oZWFkZXIuWC1BUEktS2V5J10gPSBjb25zdFBhcmFtKGFwaUtleVNlY3JldC5zZWNyZXRWYWx1ZUZyb21Kc29uKCdhcGlLZXknKS50b1N0cmluZygpKVxuICAgIHJldHVybiByZXF1ZXN0UGFyYW1zO1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdFBhcmFtKHBhcmFtZXRlcjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCcke3BhcmFtZXRlcn0nYDtcbn1cblxuY29uc3Qgc3VwcG9ydGVkUmVzcG9uc2VzID0gWzIwMCwgMjAxLCAyMDIsIDIwNCwgNDAwLCA0MDEsIDQwMywgNDA0LCA0MDUsIDQwNiwgNDA4LCA0MDksIDQxMiwgNDEzLCA0MjIsIDQyNSwgNDI4LCA0MjksIDUwMCwgNTAxLCA1MDIsIDUwMywgNTA0XTtcbiJdfQ==